#!/usr/bin/env php
<?php declare(strict_types=1);

use PatrickMaynard\AuditClassGenerator\Applier;

include $_composer_autoload_path ?? __DIR__ . '/../vendor/autoload.php';

$options = getopt('d:e:vh', ['directory:', 'extension:', 'verbose', 'help']);

$helpText = <<<TEXT
Usage: vendor/bin/audit-class-generator [options]

Options:
  -d, --directory  Verzeichnis zum Scannen (default: templates)
  -e, --extension  Dateiendung filtern (default: .html.twig)
  -v, --verbose    AusfÃ¼hrliche Ausgabe aktivieren
  -h, --help       Diese Hilfe anzeigen
TEXT;

if (isset($options['h']) || isset($options['help'])) {
    fwrite(STDOUT, $helpText . PHP_EOL . PHP_EOL . PHP_EOL);
    exit(0);
}

$config = Config::create($options);

//First, we need to be on a safe git branch, since this set of changes will mess with lots of files
exec('git checkout -b temporary-template-audit-branch-remove-me-soon');

echo PHP_EOL;
echo "Temporary git branch created. Iterating through templates ... ";
echo PHP_EOL;

$applier = new Applier($config);

$files = filterAllFilesForTwigExtension($config);

foreach ($files as $index => $file) {
    $contents = file_get_contents($file);

    file_put_contents($file, $applier->applyAllAuditTags($contents));
}

echo "Done!";
echo PHP_EOL;

//TODO: Allow blade as well. Maybe solved with configuration
function filterAllFilesForTwigExtension(Config $config): array
{
    $directoryToParse = getcwd() . DIRECTORY_SEPARATOR . $config->getDirectory();

    echo PHP_EOL . 'We will be looking recursively in ' . $directoryToParse . ' for Twig files .. ' . PHP_EOL;

    $files = getDirContents($directoryToParse);
    $output = [];

    foreach ($files as $file) {
        if (str_ends_with($file, $config->getExtension())) {
            $output[] = $file;
        }
    }

    return $output;
}

function getDirContents($dir): array
{
    $results = [];
    $files = scandir($dir);

    foreach ($files as $key => $value) {
        if (!is_dir($dir . DIRECTORY_SEPARATOR . $value)) {
            $results[] = $dir . DIRECTORY_SEPARATOR . $value;
        } elseif (
            is_dir($dir . DIRECTORY_SEPARATOR . $value)
            && !str_contains($value, '..')
            && $value !== '.'
        ) {
            $results[] = $value;
            $results = array_merge($results, getDirContents($dir . DIRECTORY_SEPARATOR . $value));
        }
    }

    return $results;
}
