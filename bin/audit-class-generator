#!/usr/bin/env php
<?php

declare(strict_types=1);

use PatrickMaynard\AuditClassGenerator\Application\BusinessLogic\Applier;
use PatrickMaynard\AuditClassGenerator\Application\Config\Config;
use PatrickMaynard\AuditClassGenerator\Infrastructure\FileSystem\DirectoryScanner;
use PatrickMaynard\AuditClassGenerator\Infrastructure\FileSystem\ExtensionFilter;
use PatrickMaynard\AuditClassGenerator\Infrastructure\FileSystem\FileIO;

include $_composer_autoload_path ?? __DIR__ . '/../vendor/autoload.php';

$options = getopt('d:e:vh', ['directory:', 'extension:', 'verbose', 'help']);

$helpText = <<<TEXT
Usage: vendor/bin/audit-class-generator [options]

Options:
  -d, --directory  Verzeichnis zum Scannen (default: templates)
  -e, --extension  Dateiendung filtern (default: .html.twig)
  -v, --verbose    AusfÃ¼hrliche Ausgabe aktivieren
  -h, --help       Diese Hilfe anzeigen
TEXT;

if (isset($options['h']) || isset($options['help'])) {
    fwrite(STDOUT, $helpText . PHP_EOL . PHP_EOL . PHP_EOL);
    exit(0);
}

$config = Config::create($options);

//First, we need to be on a safe git branch, since this set of changes will mess with lots of files
exec('git checkout -b temporary-template-audit-branch-remove-me-soon');

echo PHP_EOL;
echo "Temporary git branch created. Iterating through templates ... ";
echo PHP_EOL;

$applier = new Applier();

$scanner = new DirectoryScanner();
$filter = new ExtensionFilter($config->getExtension());
$fileIO = new FileIO();

foreach ($scanner->scan($config->getDirectory()) as $file) {
    if (!$filter->matches($file)) {
        continue;
    }

    $content = $fileIO->read($file);
    $processed = $applier->applyAllAuditTags($content);
    $fileIO->write($file, $processed);
}

echo "Done!";
echo PHP_EOL;
